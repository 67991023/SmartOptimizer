<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartData Optimizer | AI-Powered Data Pipeline</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>

<nav class="navbar">
    <div class="logo"><i class="fas fa-microchip"></i> SmartData Optimizer</div>
    <div id="session-badge" class="hidden">
        <span class="badge badge-warning" id="session-id-display">Session: None</span>
    </div>
</nav>

<div class="container">
    <div class="workflow-grid">
        <aside>
            <div class="card">
                <div class="card-title"><i class="fas fa-cloud-upload-alt"></i> 1. Import Data</div>
                <input type="file" id="fileInput" class="hidden" accept=".csv,.json,.xml,.db,.sqlite,.sqlite3,.sql,.xlsx,.xls,.parquet">
                <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-file-import"></i>
                    <p id="file-name">CSV, JSON, XML, SQLite, Excel, Parquet</p>
                </div>
                <button class="btn btn-primary" onclick="uploadFile()" style="width: 100%; margin-top: 1rem;">
                    Upload & Initialize
                </button>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-magic"></i> 2. Actions</div>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button id="btn-scan" class="btn btn-outline" onclick="scanData()" disabled>
                        <i class="fas fa-search"></i> Run Health Scan
                    </button>
                    <button id="btn-clean" class="btn btn-outline" onclick="autoClean()" disabled>
                        <i class="fas fa-broom"></i> Auto-Optimize Data
                    </button>
                    <button id="btn-undo" class="btn btn-outline" onclick="undoAction()" disabled>
                        <i class="fas fa-undo"></i> Undo Last Step
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-robot"></i> 3. Machine Learning</div>
                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.8rem; color: var(--text-muted);">Target Column</label>
                    <input type="text" id="target-col" placeholder="e.g. price" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="font-size: 0.8rem; color: var(--text-muted);">Model Type</label>
                    <select id="model-type" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px;">
                        <option value="linear_regression">Linear Regression</option>
                        <option value="random_forest_reg">Random Forest Regressor</option>
                        <option value="logistic_regression">Logistic Regression</option>
                        <option value="random_forest_clf">Random Forest Classifier</option>
                    </select>
                </div>
                <button id="btn-train" class="btn btn-primary" onclick="trainModel()" style="width: 100%;" disabled>
                    Train & Evaluate
                </button>
            </div>
        </aside>

        <main>
            <div class="card" style="min-height: 400px;">
                <div class="card-title"><i class="fas fa-table"></i> Data Preview & Insights</div>
                
                <div id="empty-state" style="text-align: center; padding: 4rem 0; color: var(--text-muted);">
                    <i class="fas fa-database" style="font-size: 3rem; opacity: 0.2; margin-bottom: 1rem;"></i>
                    <p>No data loaded. Please upload a dataset to begin.</p>
                </div>

                <div id="data-content" class="hidden">
                    <div id="scan-report" style="margin-bottom: 2rem;"></div>
                    <div class="table-container">
                        <table id="preview-table"></table>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-terminal"></i> System Logs</div>
                <div id="console">> Ready for input...</div>
            </div>
        </main>
    </div>
</div>

<script>
    const API_BASE = "";  // Same origin - served from FastAPI
    let currentSessionId = "";

    // Logging helper
    function log(message, type = 'info') {
        const consoleEl = document.getElementById('console');
        const time = new Date().toLocaleTimeString();
        consoleEl.innerHTML += `<div><span style="color: #6B7280">[${time}]</span> ${message}</div>`;
        consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    // 1. Upload File
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files[0]) return alert("Please select a file");

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        try {
            log("Uploading dataset...");
            const response = await fetch(`${API_BASE}/upload`, { method: 'POST', body: formData });
            const data = await response.json();
            
            // Check for server error
            if (!response.ok || data.detail) {
                log(`Error: ${data.detail || 'Upload failed'}`);
                return;
            }
            
            if (!data.session_id) {
                log("Error: No session ID returned from server");
                return;
            }
            
            currentSessionId = data.session_id;
            document.getElementById('session-badge').classList.remove('hidden');
            document.getElementById('session-id-display').innerText = `ID: ${currentSessionId.substring(0,8)}...`;
            
            // Enable buttons
            document.getElementById('btn-scan').disabled = false;
            document.getElementById('btn-train').disabled = false;
            
            updateUI(data.preview || []);
            
            // Show stats
            if (data.stats) {
                const s = data.stats;
                if (s.using_dask) {
                    log(`üöÄ DASK MODE: ${s.original_rows?.toLocaleString()} rows | Out-of-core processing enabled`);
                } else {
                    log(`Loaded ${s.original_rows?.toLocaleString() || '?'} rows | Memory: ${s.memory_mb}MB (saved ${s.memory_saved_pct}%)`);
                }
            }
            
            // Show info for large files
            if (data.info) {
                log(`‚ÑπÔ∏è ${data.info}`);
            }
            
            log("Upload successful. Session started.");
        } catch (e) {
            log("Error: " + e.message);
        }
    }

    // 2. Scan Data
    async function scanData() {
        try {
            log("Scanning for anomalies...");
            const response = await fetch(`${API_BASE}/scan/${currentSessionId}`);
            const report = await response.json();
            
            displayReport(report);
            document.getElementById('btn-clean').disabled = false;
            log("Health scan complete.");
        } catch (e) { log("Scan failed: " + e.message); }
    }

    // 3. Auto Clean
    async function autoClean() {
        try {
            log("Running optimization pipeline...");
            const response = await fetch(`${API_BASE}/auto-clean/${currentSessionId}`, { method: 'POST' });
            const data = await response.json();
            
            // Check for server error
            if (!response.ok || data.detail) {
                log(`Cleaning failed: ${data.detail || 'Unknown error'}`);
                return;
            }
            
            if (data.preview) {
                updateUI(data.preview);
            }
            document.getElementById('btn-undo').disabled = false;
            log(`Data cleaned & transformed. ${data.columns?.length || 0} columns.`);
        } catch (e) { log("Cleaning failed: " + e.message); }
    }

    // 4. Undo
    async function undoAction() {
        try {
            const response = await fetch(`${API_BASE}/undo/${currentSessionId}`, { method: 'POST' });
            const data = await response.json();
            if(data.preview) updateUI(data.preview);
            log(data.message);
        } catch (e) { log("Undo failed."); }
    }

    // 5. Train Model
    async function trainModel() {
        const target = document.getElementById('target-col').value;
        const modelType = document.getElementById('model-type').value;

        if (!target) return alert("Please specify a target column");

        try {
            log(`Training ${modelType} on target: ${target}...`);
            const response = await fetch(`${API_BASE}/train`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: currentSessionId,
                    target_column: target,
                    model_type: modelType
                })
            });
            const result = await response.json();
            
            if (result.status === "success") {
                log(`Success! ${result.metrics.type} Accuracy/R2: ${ (result.metrics.accuracy || result.metrics.r2_score).toFixed(4) }`, 'success');
            } else {
                log("Error: " + result.error);
            }
        } catch (e) { log("Training failed: " + e.message); }
    }

    // UI Helpers
    function updateUI(previewData) {
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('data-content').classList.remove('hidden');
        
        const table = document.getElementById('preview-table');
        if (previewData.length === 0) return;

        let html = `<thead><tr>${Object.keys(previewData[0]).map(k => `<th>${k}</th>`).join('')}</tr></thead>`;
        html += `<tbody>${previewData.map(row => `<tr>${Object.values(row).map(v => `<td>${typeof v === 'number' ? v.toFixed(2) : v}</td>`).join('')}</tr>`).join('')}</tbody>`;
        table.innerHTML = html;
    }

    function displayReport(report) {
        const container = document.getElementById('scan-report');
        let html = `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">`;
        
        // Missing Values
        html += `<div class="card" style="margin:0; border-color: #FEE2E2">
            <div style="font-weight:600; color:#991B1B; margin-bottom:8px">Missing Values</div>`;
        for (let col in report.missing_analysis) {
            html += `<div class="report-item"><span>${col}</span> <span class="badge badge-danger">${report.missing_analysis[col]}%</span></div>`;
        }
        html += `</div>`;

        // Outliers
        html += `<div class="card" style="margin:0; border-color: #FEF3C7">
            <div style="font-weight:600; color:#92400E; margin-bottom:8px">Outliers Detected</div>`;
        for (let col in report.outlier_analysis) {
            html += `<div class="report-item"><span>${col}</span> <span class="badge badge-warning">${report.outlier_analysis[col].count} rows</span></div>`;
        }
        html += `</div></div>`;

        container.innerHTML = html;
    }

    // File input label update
    document.getElementById('fileInput').addEventListener('change', function(e) {
        if(this.files[0]) document.getElementById('file-name').innerText = this.files[0].name;
    });
</script>

</body>
</html>